@using SasquatchCAIRS.Controllers.Security
@using SasquatchCAIRS.Models
@using SasquatchCAIRS.Models.ServiceSystem

@model SasquatchCAIRS.Models.ServiceSystem.RequestContent

@if (Model != null) {
    <h2>@Constants.UIString.TitleText.VIEW_REQUEST - @Constants.UIString.TitleText.REQUEST_NUM@Model.requestID</h2>
    <h4>Request Information</h4>
    <table class="table information-table">
        <tr>
            <td class="tbl-label tbl-top">@Constants.UIString.FieldLabel.CREATED_BY</td>
            <td class="tbl-content-4 tbl-top">@* TODO: Created By *@</td>

            <td class="tbl-label tbl-top">@Constants.UIString.FieldLabel.START_TIME</td>
            <td class="tbl-content-4 tbl-top">@Model.timeOpened</td>
        </tr>
        <tr>
            <td class="tbl-label">@Constants.UIString.FieldLabel.COMPLETED_BY</td>
            <td class="tbl-content-4">@* TODO: Completed By *@</td>

            <td class="tbl-label">@Constants.UIString.FieldLabel.COMPLETED_TIME</td>
            <td class="tbl-content-4">@Model.timeClosed</td>
        </tr>
        <tr>
            <td class="tbl-label">@Constants.UIString.FieldLabel.STATUS</td>
            <td class="tbl-content-4">@Constants.getStatusString(Model.requestStatus)</td>

            <td class="tbl-label">@Constants.UIString.FieldLabel.TOTAL_TIME_SPENT</td>
            <td class="tbl-content-4">@ViewBag.TimeSpent mins</td>
        </tr>
    </table>

    <h4>Caller Information</h4>
    <table class="table unbordered-table">
        <tr>
            <td class="tbl-top tbl-label">@Constants.UIString.FieldLabel.CALLER_NAME</td>
            <td class="tbl-top tbl-content-4" colspan="3">@Model.requestorFirstName @Model.requestorLastName</td>
        </tr>
        <tr>
            <td class="tbl-label tbl-border">@Constants.UIString.FieldLabel.CALLER_EMAIL</td>
            <td class="tbl-border tbl-content-4">@Model.requestorEmail</td>

            <td class="tbl-label">@Constants.UIString.FieldLabel.CALLER_TYPE</td>
            <td class="tbl-content-4">@Model.requestorTypeID @*TODO: Convert to String Value using DB*@</td>
        </tr>
        <tr>
            <td class="tbl-label">@Constants.UIString.FieldLabel.CALLER_PHONE</td>
            <td class="tbl-content-4">@Model.requestorPhoneNum @Model.requestorPhoneExt</td>

            <td class="tbl-label">@Constants.UIString.FieldLabel.CALLER_REGION</td>
            <td class="tbl-content-4">@Model.regionID @*TODO: Convert to String Value using DB*@</td>
        </tr>
    </table>

    <h4>Patient Information</h4>
    <table class="table unbordered-table">
        <tr>
            <td class="tbl-top tbl-label">@Constants.UIString.FieldLabel.PATIENT_NAME</td>
            <td class="tbl-top">@Model.patientFName @Model.patientLName</td>

            <td class="tbl-label">@Constants.UIString.FieldLabel.PATIENT_ID</td>
            <td class="tbl-content-4">@Model.patientAgencyID</td>
        </tr>
        <tr>
            <td class="tbl-label tbl-border">@Constants.UIString.FieldLabel.PATIENT_GENDER</td>
            <td class="tbl-content-4 tbl-border">@Constants.getGenderString(Model.patientGender)</td>

            <td class="tbl-label tbl-border">@Constants.UIString.FieldLabel.PATIENT_AGE</td>
            <td class="tbl-content-4 tbl-border">@Model.patientAge</td>
        </tr>
    </table>

    <h4>Question Information</h4>
    foreach (QuestionResponseContent qr in Model.questionResponseList) {
        <table class="table unbordered-table no-margin">
            <tr>
                <td class="focal">@qr.question</td>
            </tr>
            <tr>
                <td>@qr.response</td>
            </tr>
        </table>
    
        <table class="table unbordered-table no-margin">
            <tr>
                <td class="focal" colspan="6">@Constants.UIString.FieldLabel.SPECIAL_NOTES</td>
            </tr>
            <tr>
                <td colspan="6">@qr.specialNotes</td>
            </tr>
            
            <tr>
                <td class="tbl-label">@Constants.UIString.FieldLabel.QUESTION_TYPE</td>
                <td class="tbl-content-6">@qr.questionTypeID @*TODO: Convert using DB *@</td>

                <td class="tbl-label">@Constants.UIString.FieldLabel.TUMOUR_GROUP</td>
                <td class="tbl-content-6">@qr.tumourGroupID @*TODO: Convert to String Value using DB*@</td>

                <td class="tbl-label">@Constants.UIString.FieldLabel.TIME_SPENT</td>
                <td class="tbl-content-6">@qr.timeSpent mins</td>
            </tr>
        </table>
    
        <div class="sxs">
            <div class="sxs-one impact">
                <table class="table unbordered-table no-margin">
                    <tr>
                        <td class="focal" colspan="4">
                            @Constants.UIString.FieldLabel.IMPACT_SCORE
                        </td>
                    </tr>
                    <tr>
                        <td rowspan="3" class="spacer">&nbsp;</td>
                        <td rowspan="3" class="tbl-label impact calc-impact-@Constants.getImpactScore(qr.severity, qr.consequence)">
                            <div class="score">@Constants.getImpactScore(qr.severity, qr.consequence)</div>
                        </td> 
                    </tr>
                    <tr>
                        <td class="impact-calc tbl-impact-label calc-sev-@qr.severity">
                            <div class="impact-sev-label">@Constants.UIString.FieldLabel.SEVERITY</div>
                        </td>
                        <td class="impact-calc calc-sev-@qr.severity">
                            <div class="impact-sev">@qr.severity</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="impact-calc tbl-impact-label calc-cons-@qr.consequence">
                            <div class="impact-cons-label">@Constants.UIString.FieldLabel.CONSEQUENCE</div>
                        </td>
                        <td class="impact-calc calc-cons-@qr.consequence">
                            <div class="impact-cons">@qr.consequence</div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="sxs-one keywords">
                <table class="table unbordered-table">
                    <tr>
                        <td class="focal">@Constants.UIString.FieldLabel.KEYWORDS</td>
                    </tr>
                    <tr>
                        <td>@foreach(KeywordContent kw in qr.keywords) { <span>@kw.keywordStr </span> }</td>
                    </tr>
                </table>
            </div>
        </div>
        
        
        <table class="table">
            <tr>
                <td class="focal tbl-top">
                    @Constants.UIString.FieldLabel.REFERENCES
                </td>
            </tr>
            @foreach (ReferenceContent reference in qr.referenceList) {
                <tr>
                    <td class="tbl-label">@Constants.getReferenceString(reference.referenceType)</td>
                    @if (reference.referenceType == Constants.ReferenceType.URL) {
                        <td><a href="@reference.referenceString">@reference.referenceString</a></td>
                    }
                    @if (reference.referenceType == Constants.ReferenceType.File) {
                        <td><a href="file://@reference.referenceString">@reference.referenceString</a></td>
                    }
                    @if (reference.referenceType == Constants.ReferenceType.Text) {
                        <td>@reference.referenceString</td>
                    }
                </tr>
            }
        </table>
    }

    <h4>Properties</h4>
    <table class="table information-table">
        <tr>
            <td class="tbl-label tbl-top">@Constants.UIString.FieldLabel.PARENT_REQUEST</td>
            <td width="85%" class="tbl-top">@Model.parentRequestID</td>
        </tr>
    </table>

    <div class="buttons">
        @if (User.IsInRole(Constants.Roles.REQUEST_EDITOR)) {
            @Html.ActionLink(Constants.UIString.ButtonText.EDIT_REQUEST, "Edit", "Request", new {id = Model.requestID}, new {
                @class = "btn btn-info edit-button"
            })
        } 

        @Html.ActionLink(Constants.UIString.ButtonText.EXPORT_REQUEST, "Export", "Request", new {id = Model.requestID}, new {
            @class = "btn btn-info export-button"
        }) 
    
        @if (User.IsInRole(Constants.Roles.ADMINISTRATOR) && RequestLockController.instance.isLocked(Model.requestID)) {
            @Html.ActionLink(Constants.UIString.ButtonText.UNLOCK_REQUEST, "Unlock", "Request", new {id = Model.requestID}, new {
                @class = "btn btn-info unlock-button"
            })
        }
    </div>
}

@if (Model == null) {
    <h2>@Constants.UIString.TitleText.VIEW_REQUEST - @Constants.UIString.TitleText.ERROR</h2>
    <p>Cannot open request. You may not have the appropriate permissions to access this request.</p>
}